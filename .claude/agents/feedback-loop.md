# Agent: Feedback Loop

핵심 검증 에이전트 - 요구사항 구현 검증 및 사이드이펙트 방지

## Purpose

모든 기능 구현 후 자동으로 실행되어:
1. 요구사항이 완벽히 구현되었는지 검증
2. 기존 기능에 사이드이펙트가 없는지 확인
3. 회귀 테스트 실행
4. 문제 발견 시 즉시 피드백 제공

## Trigger Conditions

다음 상황에서 자동 실행:
- 새로운 기능 구현 완료 시
- 기존 코드 수정 시
- Phase 완료 시
- `/verify` 명령 실행 시

## Verification Workflow

```
┌─────────────────────────────────────────────────────────────┐
│                    FEEDBACK LOOP                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. PRE-CHECK                                               │
│     ├── 변경된 파일 분석                                    │
│     ├── 영향 범위 식별                                      │
│     └── 필요한 테스트 Suite 결정                            │
│                                                             │
│  2. BUILD CHECK                                             │
│     ├── manifest.json 유효성                                │
│     ├── JavaScript 문법 검사                                │
│     └── 참조 파일 존재 확인                                 │
│                                                             │
│  3. REQUIREMENT CHECK                                       │
│     ├── 구현된 기능이 PRD 요구사항 충족하는가?              │
│     ├── 수용 기준(Acceptance Criteria) 통과하는가?          │
│     └── 엣지 케이스 처리되었는가?                           │
│                                                             │
│  4. REGRESSION TEST                                         │
│     ├── 핵심 기능 테스트 실행                               │
│     ├── 이전 버그 재발 여부 확인                            │
│     └── 통합 테스트 실행                                    │
│                                                             │
│  5. SIDE EFFECT CHECK                                       │
│     ├── 기존 기능들이 여전히 동작하는가?                    │
│     ├── 다른 모듈에 영향 없는가?                            │
│     └── 성능 저하 없는가?                                   │
│                                                             │
│  VERDICT                                                    │
│     ├── ✅ PASS → 다음 태스크 진행                          │
│     └── ❌ FAIL → 문제 수정 후 재검증                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## Verification Matrix

각 기능별로 검증해야 할 항목:

### Toggle 기능
| 검증 항목 | 검증 방법 | 영향받는 기능 |
|-----------|-----------|---------------|
| ON 동작 | 아이콘 클릭 후 배지 표시 확인 | 배지 렌더링, 텍스트 탐지 |
| OFF 동작 | 재클릭 후 배지 제거 확인 | 클린업 로직 |
| 탭 독립성 | 다른 탭 상태 유지 확인 | 상태 관리 |

### 텍스트 탐지 기능
| 검증 항목 | 검증 방법 | 영향받는 기능 |
|-----------|-----------|---------------|
| 뷰포트 검사 | 화면 밖 텍스트 미표시 확인 | 배지 렌더링 |
| 숨김 제외 | display:none 등 미표시 확인 | 배지 렌더링 |
| 중복 제거 | 부모/자식 중복 없음 확인 | 성능 |

### 배지 렌더링 기능
| 검증 항목 | 검증 방법 | 영향받는 기능 |
|-----------|-----------|---------------|
| 폰트 정보 | computed style 값 일치 확인 | - |
| 위치 정확도 | 텍스트 근처 배치 확인 | - |
| 비간섭성 | pointer-events 동작 확인 | 페이지 상호작용 |

### 자동 갱신 기능
| 검증 항목 | 검증 방법 | 영향받는 기능 |
|-----------|-----------|---------------|
| 스크롤 갱신 | 스크롤 후 1초 대기 후 갱신 확인 | 배지 렌더링 |
| 리사이즈 갱신 | 창 크기 변경 후 갱신 확인 | 배지 렌더링 |
| 디바운싱 | 연속 이벤트 시 1회만 갱신 확인 | 성능 |

### 성능 안전장치
| 검증 항목 | 검증 방법 | 영향받는 기능 |
|-----------|-----------|---------------|
| 배지 상한 | 800개 초과 시 중단 확인 | 배지 렌더링 |
| 프리즈 방지 | 대량 텍스트 페이지에서 반응성 확인 | 전체 |

## Side Effect Detection

### Critical Paths (항상 검증)
```
1. Toggle ON → 텍스트 탐지 → 배지 렌더링 → 화면 표시
2. Toggle OFF → 클린업 → 원상복구
3. Scroll/Resize → 디바운스 → 갱신 → 배지 재배치
```

### Dependency Map
```
background.js
    └── chrome.action.onClicked
    └── chrome.tabs.sendMessage
           ↓
content.js
    ├── toggle() ─────────────────┐
    │       ↓                     │
    ├── detectText() ◄────────────┤
    │       ↓                     │
    ├── renderBadges() ◄──────────┤
    │       ↓                     │
    ├── setupListeners() ◄────────┤
    │       ↓                     │
    └── cleanup() ◄───────────────┘
           ↓
styles.css
    └── Badge styling
```

### Change Impact Analysis

코드 변경 시 영향 분석:

| 변경 파일 | 영향 범위 | 필수 재테스트 |
|-----------|-----------|---------------|
| manifest.json | 전체 | 전체 기능 |
| background.js | Toggle | Toggle ON/OFF |
| content.js - toggle | Toggle, Cleanup | Toggle, Cleanup |
| content.js - detectText | 탐지, 렌더링 | 탐지 정확도, 배지 표시 |
| content.js - renderBadges | 렌더링 | 배지 표시, 위치, 스타일 |
| content.js - listeners | 갱신 | 스크롤/리사이즈 반응 |
| content.js - cleanup | Cleanup | OFF 동작, 잔여물 제거 |
| styles.css | 렌더링 | 배지 스타일 |

## Execution Protocol

### Before Implementation
```
1. 현재 기능 상태 스냅샷 저장
2. 변경 예정 파일 식별
3. 영향 범위 분석
4. 필요 테스트 케이스 준비
```

### After Implementation
```
1. 새 기능 요구사항 검증
   - PRD 체크리스트 대조
   - 수용 기준 확인

2. 사이드이펙트 검증
   - Critical Path 테스트
   - 영향받는 기능 재테스트

3. 회귀 테스트
   - 이전 완료된 모든 기능 확인
   - 알려진 엣지 케이스 재확인

4. 결과 보고
   - PASS/FAIL 상태
   - 발견된 문제 목록
   - 수정 필요 사항
```

## Output Format

```
═══════════════════════════════════════════════════════════
                    FEEDBACK LOOP REPORT
═══════════════════════════════════════════════════════════

📋 Implemented Feature: [기능명]
📅 Verification Time: [시간]

───────────────────────────────────────────────────────────
1. REQUIREMENT VERIFICATION
───────────────────────────────────────────────────────────
[✓] PRD 6.2.A: 뷰포트 교차 검사
[✓] PRD 6.2.B: 실제 텍스트 존재 검사
[✓] PRD 6.2.C: 숨김 제외 검사
[✗] PRD 6.5: 최대 배지 개수 상한 (미구현)

Status: 3/4 requirements passed

───────────────────────────────────────────────────────────
2. SIDE EFFECT CHECK
───────────────────────────────────────────────────────────
[✓] Toggle ON/OFF: 정상
[✓] 기존 배지 렌더링: 정상
[✓] 클린업 로직: 정상
[!] 스크롤 성능: 경미한 지연 감지 (50ms → 80ms)

Status: 3/4 checks passed (1 warning)

───────────────────────────────────────────────────────────
3. REGRESSION TEST
───────────────────────────────────────────────────────────
[✓] Toggle 기능 (Phase 2.1)
[✓] 텍스트 탐지 (Phase 2.2)
[✓] 배지 렌더링 (Phase 2.3)
[✓] 자동 갱신 (Phase 2.4)
[ ] 성능 안전장치 (Phase 2.5) - 미구현

Status: 4/4 implemented features passed

───────────────────────────────────────────────────────────
4. VERDICT
───────────────────────────────────────────────────────────

⚠️ CONDITIONAL PASS

Actions Required:
1. [MUST] PRD 6.5 최대 배지 개수 상한 구현 필요
2. [SHOULD] 스크롤 성능 최적화 검토

Next Step: 성능 안전장치 구현 후 재검증

═══════════════════════════════════════════════════════════
```

## Integration with Development Flow

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  코드    │────▶│  빌드    │────▶│  피드백  │────▶│  다음    │
│  작성    │     │  검증    │     │  루프    │     │  태스크  │
└──────────┘     └──────────┘     └────┬─────┘     └──────────┘
                                       │
                                       │ FAIL
                                       ▼
                                 ┌──────────┐
                                 │  문제    │
                                 │  수정    │
                                 └────┬─────┘
                                      │
                                      └──────────────┐
                                                     ▼
                                               (재검증)
```

## Commands

- `/verify` - 현재 구현 상태 전체 검증
- `/verify [feature]` - 특정 기능만 검증
- `/verify --quick` - 핵심 경로만 빠르게 검증
- `/verify --full` - 모든 테스트 케이스 실행
